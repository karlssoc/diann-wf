// DIANN Workflow - Base Configuration
// Compatible with Nextflow DSL2

// Enable DSL2
nextflow.enable.dsl = 2

// Default parameters - can be overridden via config files or command line
params {
    // Container settings
    container_registry = 'quay.io/karlssoc/diann'
    diann_version = '2.3.1'

    // Default resource settings
    threads = 60

    // Output directory
    outdir = 'results'

    // SLURM settings (can be overridden)
    slurm_account = null
    slurm_queue = null

    // Help message
    help = false
}

// Container configuration (enabled per-profile below)
// singularity {
//     enabled = true
//     autoMounts = true
//     cacheDir = "${HOME}/.singularity/cache"
// }

docker {
    enabled = false
}

// Process defaults
process {
    // Default container for all processes
    container = "${params.container_registry}:${params.diann_version}"

    // Error strategy
    errorStrategy = 'retry'
    maxRetries = 2

    // Default resources
    cpus = 1
    memory = '4 GB'
    time = '1h'
}

// Execution profiles
profiles {
    standard {
        process.executor = 'local'
        singularity {
            enabled = true
            autoMounts = true
            cacheDir = "${HOME}/.singularity/cache"
        }
    }

    slurm {
        singularity {
            enabled = true
            autoMounts = true
            cacheDir = "${HOME}/.singularity/cache"
        }

        executor {
            name = 'slurm'
            queueSize = 100
        }

        process {
            executor = 'slurm'
            queue = params.slurm_queue
            clusterOptions = params.slurm_account ? "--account=${params.slurm_account}" : ''

            // Process-specific resources
            withLabel: 'diann_tune' {
                cpus = 10
                memory = '10 GB'
                time = '2h'
            }

            withLabel: 'diann_library' {
                cpus = { params.threads }
                memory = '30 GB'
                time = '4h'
            }

            withLabel: 'diann_quantify' {
                cpus = { params.threads }
                memory = { 500.MB * params.threads }
                time = '8h'
            }
        }
    }

    docker {
        process.executor = 'local'
        docker {
            enabled = true
            runOptions = '-u $(id -u):$(id -g)'
        }
    }

    docker_slurm {
        docker {
            enabled = true
            runOptions = '-u $(id -u):$(id -g)'
        }

        executor {
            name = 'slurm'
            queueSize = 100
        }

        process {
            executor = 'slurm'
            queue = params.slurm_queue
            clusterOptions = params.slurm_account ? "--account=${params.slurm_account}" : ''

            // Process-specific resources
            withLabel: 'diann_tune' {
                cpus = 10
                memory = '10 GB'
                time = '2h'
            }

            withLabel: 'diann_library' {
                cpus = { params.threads }
                memory = '30 GB'
                time = '4h'
            }

            withLabel: 'diann_quantify' {
                cpus = { params.threads }
                memory = { 500.MB * params.threads }
                time = '8h'
            }
        }
    }

    podman {
        process.executor = 'local'
        podman {
            enabled = true
        }
    }

    podman_slurm {
        podman {
            enabled = true
        }

        executor {
            name = 'slurm'
            queueSize = 100
        }

        process {
            executor = 'slurm'
            queue = params.slurm_queue
            clusterOptions = params.slurm_account ? "--account=${params.slurm_account}" : ''

            // Process-specific resources
            withLabel: 'diann_tune' {
                cpus = 10
                memory = '10 GB'
                time = '2h'
            }

            withLabel: 'diann_library' {
                cpus = { params.threads }
                memory = '30 GB'
                time = '4h'
            }

            withLabel: 'diann_quantify' {
                cpus = { params.threads }
                memory = { 500.MB * params.threads }
                time = '8h'
            }
        }
    }

    test {
        process {
            executor = 'local'
            cpus = 2
            memory = '4 GB'
        }
        params {
            threads = 2
        }
    }
}

// Execution report settings
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_timeline.html"
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_report.html"
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_trace.txt"
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.svg"
}

// Manifest
manifest {
    name = 'diann-workflow'
    author = 'karlssoc'
    description = 'Modular Nextflow workflow for DIA-NN mass spectrometry analysis'
    mainScript = 'main.nf'
    nextflowVersion = '>=21.04.0'
    version = '1.0.0'
}
