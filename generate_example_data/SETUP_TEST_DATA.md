# Test Data Setup Guide

Complete guide for setting up test data using your .dia files.

## Current Status ✅

You have:
- ✅ **3 × .dia files** at 14 MB each (perfect size!)
- ✅ **DIA-NN output** showing **1,147 detected proteins**
- ⏳ Need to create minimal FASTA file

## Quick Setup (3 Steps)

### Step 1: Generate Minimal FASTA ⭐

Run the interactive script:

```bash
cd generate_example_data
./generate_test_fasta.sh
```

This will:
1. Count proteins detected in your .dia files (1,147 proteins)
2. Ask for path to your full FASTA file
3. Let you choose FASTA size:
   - **Option 2 (Recommended): Top 500 proteins** (~50-80 KB)
   - Option 1: All 1,147 proteins (~120-150 KB)
   - Option 3: Top 300 proteins (~30-50 KB)

**Recommendation:** Use **Option 2 (500 proteins)** - best balance for testing.

### Step 2: Copy .dia Files to Test Data

```bash
# Create test directories
mkdir -p ../test_data/raw/sample1
mkdir -p ../test_data/raw/sample2

# Copy .dia files (using 2 samples for multi-sample testing)
cp CK_M2512_002.dia ../test_data/raw/sample1/
cp CK_M2512_003.dia ../test_data/raw/sample2/
```

### Step 3: Setup Git LFS (for 28 MB of test data)

```bash
cd ../test_data
./setup_git_lfs.sh
```

## What You'll Have

```
test_data/
├── fasta/
│   └── minimal_proteome.fasta      # 500 proteins, ~60 KB
├── raw/
│   ├── sample1/
│   │   └── CK_M2512_002.dia       # 14 MB
│   └── sample2/
│       └── CK_M2512_003.dia       # 14 MB
└── expected_outputs/
    └── (generated by tests)
```

**Total size:** ~28 MB (perfect for Git LFS)

## Why These Numbers?

### Detected Proteins: 1,147
- This is what DIA-NN found in your test .dia files
- Yeast proteome (YEAST proteins)
- Good representation of real data

### Recommended FASTA Size: 500 Proteins

| Size | Proteins | File Size | Use Case |
|------|----------|-----------|----------|
| Minimal | 300 | ~40 KB | Fastest tests |
| **Recommended** | **500** | **~60 KB** | **Best balance** ⭐ |
| Complete | 1,147 | ~140 KB | Most comprehensive |
| Full proteome | 6,000+ | ~3 MB | Too large for tests |

**Why 500 proteins?**
- ✅ Covers most abundant proteins (best detected)
- ✅ Fast library generation (~30-60 sec)
- ✅ Representative of real workflow
- ✅ Small file size for git
- ✅ Good for CI/CD

### Why 2 Samples (Not 3)?

You have 3 .dia files, but **use only 2 for test data**:
- ✅ Tests multi-sample workflows (critical!)
- ✅ Validates channel broadcasting (bug we fixed)
- ✅ Keeps total size at 28 MB (manageable)
- ✅ Fast test execution (~5-10 min)

Keep the 3rd file in `generate_example_data/` as backup.

## Testing Your Setup

### Test 1: Library Generation

```bash
cd ..  # Back to repo root
nextflow run workflows/create_library.nf \
  -params-file configs/test/library_test.yaml \
  -profile standard
```

**Expected:**
- Runtime: 30-60 seconds
- Output: `test_data/expected_outputs/test_library.predicted.speclib`

### Test 2: Quantification (2 samples)

```bash
nextflow run workflows/quantify_only.nf \
  -params-file configs/test/quick_test.yaml \
  -profile standard
```

**Expected:**
- Runtime: 5-10 minutes
- Output: `test_results/test_sample1/` and `test_results/test_sample2/`

## File Format Details

### Why .dia Files Are Great for Testing

**Advantages over .mzML:**
- ✅ Smaller file size (~30% reduction)
- ✅ Faster to read (native format)
- ✅ Pre-processed (centroided, filtered)
- ✅ DIA-NN optimized
- ✅ No conversion needed

**Your .dia files:**
- Source: Converted from .raw with msconvert
- Processing: Peak picked, filtered, compressed
- Size: 14 MB each (vs ~20 MB for equivalent mzML)
- Spectra: ~1,500-2,000 per file

### FASTA File Requirements

**Must match MS data:**
- Your .dia files contain **yeast peptides**
- FASTA must be **yeast proteome** (Saccharomyces cerevisiae)
- Should include the 1,147 detected proteins

**Script ensures:**
- ✅ Only proteins detected in your test data
- ✅ Sorted by abundance (most important first)
- ✅ Proper FASTA formatting
- ✅ UniProt IDs preserved

## Troubleshooting

### "Protein not found in FASTA"

If the script reports missing proteins:
- Check you're using the correct organism (yeast)
- Try the full yeast proteome FASTA
- Some protein IDs may have changed - this is OK if <10% missing

### "DIA-NN protein matrix not found"

Run DIA-NN on your .dia files first:
```bash
# This should have been done already
diann --f *.dia --lib existing_library.speclib --fasta full.fasta
```

### File Size Too Large

If total test data exceeds 30 MB:
- Use `--top 300` for FASTA (smaller)
- Or use only 2 .dia files instead of 3
- Current setup (2 × 14 MB + 60 KB) = **28 MB** ✅

## Manual FASTA Creation (Alternative)

If the script doesn't work, manual approach:

```bash
# Extract protein IDs
tail -n +2 diann/report.pg_matrix.tsv | \
  cut -f1 | \
  head -500 > protein_ids.txt

# Filter FASTA (requires seqtk or similar)
seqtk subseq full_yeast.fasta protein_ids.txt > minimal_proteome.fasta
```

## Next Steps After Setup

1. ✅ Test locally with standard profile
2. ✅ Commit test data with Git LFS
3. ✅ Update CI/CD to use test configs
4. ✅ Document expected results

## Summary

- **Step 1:** `./generate_test_fasta.sh` → Choose option 2 (500 proteins)
- **Step 2:** Copy 2 .dia files to `test_data/raw/sample*/`
- **Step 3:** `./setup_git_lfs.sh` in test_data/
- **Step 4:** Test workflows
- **Step 5:** Commit to git

**Final size:** ~28 MB total (managed with Git LFS)
**Test runtime:** ~5-10 minutes
**Proteins:** 500 most abundant from 1,147 detected
